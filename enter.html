<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>データ入力 (enter.html)</title>
</head>
<body>
    <h1>データ入力・編集 (enter.html)</h1>
    <p><a href="view.html" target="_blank">→ 閲覧用画面 (view.html) を開く</a></p>

    <button type="button" id="addRowBtn">＋ 新しい行を追加</button>
    <button type="button" id="downloadBtn">CSVとして書き出し</button>
    <button type="button" id="resetAllBtn" style="color: red; margin-left: 20px;">全消去</button>

    <table border="1" id="listTable" cellpadding="5" style="border-collapse: collapse; width: 100%; margin-top: 10px;">
        <thead>
            <tr style="background-color: #f9f9f9;">
                <th>名称</th>
                <th>種類</th>
                <th>識別番号</th>
                <th>数値1(DC,R,V)</th>
                <th>数値2(AC,F,A)</th>
                <th>数値3(その他)</th>
                <th>個数</th>
                <th>備考</th>
                <th>データシート (外部URL)</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        let allData = JSON.parse(localStorage.getItem('shared_csv_data')) || [Array(9).fill("")];

        function renderTable() {
            const tbody = document.querySelector('#listTable tbody');
            tbody.innerHTML = "";
            allData.forEach((row, rowIndex) => {
                const tr = document.createElement('tr');
                row.forEach((cellValue, colIndex) => {
                    const td = document.createElement('td');

                    if (colIndex === 8) {
                        // データシート列: URL入力用テキストボックス
                        const input = document.createElement('input');
                        input.type = "url";
                        input.value = cellValue;
                        input.placeholder = "https://...";
                        input.style.width = "95%";
                        input.onblur = () => {
                            allData[rowIndex][colIndex] = input.value;
                            saveData();
                        };
                        td.appendChild(input);
                    } else {
                        // その他の列: 直接編集
                        td.contentEditable = true;
                        td.textContent = cellValue;
                        td.onblur = () => {
                            allData[rowIndex][colIndex] = td.textContent;
                            saveData();
                        };
                    }
                    tr.appendChild(td);
                });

                const actionTd = document.createElement('td');
                const delBtn = document.createElement('button');
                delBtn.textContent = "削除";
                delBtn.onclick = () => { if (confirm("削除しますか？")) { allData.splice(rowIndex, 1); saveAndRender(); } };
                actionTd.appendChild(delBtn);
                tr.appendChild(actionTd);
                tbody.appendChild(tr);
            });
        }

        function saveData() {
            localStorage.setItem('shared_csv_data', JSON.stringify(allData));
        }

        function saveAndRender() {
            saveData();
            renderTable();
        }

        document.getElementById('addRowBtn').onclick = () => { allData.push(Array(9).fill("")); saveAndRender(); };

        document.getElementById('downloadBtn').onclick = () => {
            const headers = ["名称", "種類", "識別番号", "数値1", "数値2", "数値3", "個数", "備考", "データシート"];
            let csvContent = "\uFEFF" + headers.join(",") + "\r\n"; // UTF-8 BOM
            allData.forEach(row => { csvContent += row.map(c => `"${c}"`).join(",") + "\r\n"; });
            const blob = new Blob([csvContent], { type: "text/csv" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "data.csv";
            a.click();
        };

        document.getElementById('resetAllBtn').onclick = () => {
            if (confirm("全てのデータを消去しますまか？")) { allData = [Array(9).fill("")]; saveAndRender(); }
        };

        renderTable();
    </script>
</body>
</html>